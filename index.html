<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
<head>
    <title>Google Maps API v3 Test...</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="js/jquery-1.9.0.min.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.7/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.7/mapbox.css' rel='stylesheet' />

    <script type="text/javascript" src="js/amcharts.js"></script>
    <script type="text/javascript" src="js/serial.js"></script>
    <script type="text/javascript" src="js/light.js"></script>

    <script src="lib/d3.min.js"></script>
    <script src="lib/hexbin.js"></script>
    <script src="lib/simple_statistics.js"></script>
    <script src="js/jquery-2.0.2.min.map.js"></script>

    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-45101494-1']);
        _gaq.push(['_setDomainName', 'delimited.io']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>


    <script type="text/javascript">
        //<![CDATA[
        $(document).ready(function(){


            //alert($.cookie("currentState"));


// when we apply theme, the dataUpdated event is fired even before we add listener, so
// we need to call zoomChart here

// this method is called when chart is first inited as we listen for "dataUpdated" event
            function zoomChart() {
                // different zoom methods can be used - zoomToIndexes, zoomToDates, zoomToCategoryValues
                chart.zoomToIndexes(chartData.length - 250, chartData.length - 1);
            }

// generate some random data, quite different range
            function generateChartData(time,count) {
                var chartData = [];
                // current date
                //var firstDate = new Date();
                // now set 500 minutes back
                //firstDate.setMinutes(firstDate.getDate() - 3000);

                // and generate 500 data items
                for (var i = 0; i < time.length; i++) {
                    var newDate = new Date(time[i]);
                    // each time we add one minute
                    newDate.setMinutes(newDate.getMinutes());


                    var visits = count[i];
                    // add data item to the array
                    chartData.push({
                        date: newDate,
                        visits: visits
                    });
                }
                return chartData;
            }


            main();
            //setInterval(main,10000);

            function main(){

                if($.cookie("currentState")){
                    var curState = $.cookie("currentState").split("/")[0];
                    var curHash = $.cookie("currentState").split("/")[1];
                    var curFlag = $.cookie("currentState").split("/")[2];

                    if(curFlag=="state")
                        curHash="";
                }
                else{
                    var curState = $("#state").val();
                    var curHash = "";
                    var curFlag = ""
                }

                //alert(curState+"/"+curHash);
                $.ajax({
                    url:"php/update_file.php",
                    data:{state:curState,hash:curHash,flag:curFlag},
                    type:"POST",
                    dataType:"json",
                    success:function(result){

                        $("#topic").html(result[2][0]);
                        for(var i=0;i<result[2].length;i++){
                            $("#hash_tag").append("<option>"+result[2][i]+"</option>");
                        }

                        if(!$.cookie("currentState")){
                            $.cookie("currentState",$("#state").val()+"/"+$("#hash_tag").val()+"/hash_tag",{expire:1});
                        }
                        else{
                            $("#state").val($.cookie("currentState").split("/")[0]);
                            if($.cookie("currentState").split("/")[2]!="state")
                                $("#hash_tag").val($.cookie("currentState").split("/")[1]);

                            //else $("#hash_tag").val($.cookie("currentState").split("/")[1]);
                        }

                        for(var i=0;i<result[0].length;i++){
//                            store_locations[i]=new google.maps.LatLng(result[0][i],result[1][i]);
                            store_locations[i]=(result[0][i],result[1][i]);
                            tweets[i]=result[3][i];
                            names[i]=result[4][i];
                            //TODO: getting params for it
                            lat[i] = result[0][i];
                            lon[i] = result[1][i];
                        }


                        //$("#hash_tag").val($.cookie("currentState").split("/")[1]);


                        for(var i=0;i<result[5].length;i++){
                            /*var newDate = new Date(result[5][i]);
                             var count = result[6][i];
                             newDate.setMinutes(newDate.getMinutes());*/

                            time[i]=result[5][i];
                            count[i]=result[6][i];
                            /*chartData.push({
                             date:newDate,
                             visits:count
                             });*/
                        }
                        //alert(states["New York longitude"].toFixed(4));
                        setChartData(time,count,$("#hash_tag").val());
                        check($("#state").val());
                        initialize($("#state").val());


                    },
                    error:function(xhr){
                        alert(xhr.status);
                    }
                });
            }

         //   L.mapbox.accessToken = 'pk.eyJ1IjoiZGVlcGFrcm9oYW4iLCJhIjoiclRaa0p6MCJ9.pBHILcdWViOC-si6hlpWjQ';
            var map;
            var store_locations = new Array();
            var hash_tags = new Array();
//            var markers = new Array();
            var longitude = new Array();
            var latitude = new Array();
            var temp=new Array();
            var tweets=new Array();
            var names=new Array();
            var time=new Array();
            var count=new Array();
            //TODO: TWO ARRAYS AS LON AND LAT
            var lon = new Array();
            var lat = new Array();

            /*var states = new Object();
             states["California"]["latitude"] = 37.0000;
             states[California][longitude] = -120.0000;
             states["New York"]["latitude"] = 42.3482;
             states["New York"]["longitude"] = 75.1890;
             states["New York"]["latitude"] = 42.3482;*/

            var states = {"California latitude":37.0000,"California longitude":-120.0000,
                "New York latitude":42.3482,"New York longitude":-75.1890,
                "North Carolina latitude":35.5000,"North Carolina longitude":-80.0000,
                "Illinois latitude":40.0000,"Illinois longitude":-89.0000
            };

            var goldStar = 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle_highlight.png';

            $("#state,#hash_tag").change(function(){

                $.cookie("currentState",$("#state").val()+"/"+$("#hash_tag").val()+"/"+$(this).attr("id"),{expire:1});
                location.reload();
                //$("#hexbinContainer").html("");
                check($(this).val());
                initialize($(this).val());
                $("#myBody").html()
                $("#myBody").html($("#hexbinContainer").html());

            });

            function setChartData(times,counts,tag){
                var chartData=generateChartData(times,counts)

                var chart = AmCharts.makeChart("chartdiv", {
                    "type": "serial",
                    "theme": "light",
                    "pathToImages": "http://www.amcharts.com/lib/3/images/",
                    "dataProvider": chartData,
                    "valueAxes": [{
                        "position": "left",
                        "title": tag
                    }],
                    "graphs": [{
                        "fillAlphas": 0.4,
                        "valueField": "visits"
                    }],
                    "chartScrollbar": {},
                    "chartCursor": {
                        "categoryBalloonDateFormat": "JJ:NN, DD MMMM",
                        "cursorPosition": "mouse"
                    },
                    "categoryField": "date",
                    "categoryAxis": {
                        "minPeriod": "mm",
                        "parseDates": true
                    }
                });
                chart.addListener("dataUpdated", zoomChart);
                //zoomChart();
            }

            function initialize(state) {
                var map_center = new google.maps.LatLng(states[state+" latitude"].toFixed(4),states[state+" longitude"].toFixed(4));
                alert(map_center);
                alert("Initialize");
                var myOptions = {
                    zoom: 10,
                    center: map_center,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                }

                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
               //TODO: OUTSIDE DECLARATION OF INFO
                var infowindow = new google.maps.InfoWindow();

                for(i=0;i<store_locations.length;i++)
                {
                    alert("This is the total"+store_locations.length)
                    //TODO change to vars and try
                    //                    var tweet = tweets[i];
//                    alert("Checking");
                    var offsetLat = lat[i];
                    alert("lats" +lat.length)
                    alert(offsetLat);
                    var offsetLng = lon[i];
                    alert(offsetLng);
                   var point = new google.maps.LatLng(parseFloat(offsetLat), parseFloat(offsetLng));
                    alert("Point"+point);
//                    alert(store_locations[i]);
                    //TODO ADD DYNAMIC CONTENT
                    var tweeps = tweets[i]; //TODO use a diff naming convention


                 var   marker = new google.maps.Marker(
                            { position: point,
                                map: map,
                                title: tweeps,
                                icon: goldStar
                            } );
                    //TODO: New info window here

                    var popupContent = '<div id="locationContent">' +
                            '<div> <h1>Tweeted: </h1>'+ tweeps + '</div><br/>' +
                            '</div>';

                    createInfoWindow(marker, popupContent);


//                    google.maps.event.addListener(marker, 'click', function() {
//                        infowindow.setContent("Tweet :"+tweeps);
//                        infowindow.open(map,marker);
//                    });
                    //TODO: alerts to check if params are passing comment them
//                        alert(tweets[i]);
//                        alert("Latitude" +lat[i]);
//                        alert("Longitude" +lon[i]);

                }
                function createInfoWindow(marker,popupContent){
                    google.maps.event.addListener(marker,'click',function(){
                       infowindow.setContent(popupContent);
                        infowindow.open(map,this)
                    });
                }
            }









            google.maps.event.addDomListener(window, 'load', initialize);

            //**********************************************************************************
            //********  IMPORT DATA AND REFORMAT ***********************************************
            //**********************************************************************************



            function check(state_code){


                L.HexbinLayer = L.Class.extend({
                    includes: L.Mixin.Events,
                    initialize: function (rawData, options) {
                        this.levels = {};
                        this.layout = d3.hexbin().radius(10);
                        this.rscale = d3.scale.sqrt().range([0, 10]).clamp(true);
                        this.rwData = rawData;
                        this.config = options;
                    },
                    project: function(x) {
                        var point = this.map.latLngToLayerPoint([x[1], x[0]]);
                        return [point.x, point.y];
                    },
                    getBounds: function(d) {
                        var b = d3.geo.bounds(d)
                        return L.bounds(this.project([b[0][0], b[1][1]]), this.project([b[1][0], b[0][1]]));
                    },
                    update: function () {
                        var pad = 100, xy = this.getBounds(this.rwData), zoom = this.map.getZoom();

                        this.container
                                .attr("width", xy.getSize().x + (2 * pad))
                                .attr("height", xy.getSize().y + (2 * pad))
                                .style("margin-left", (xy.min.x - pad) + "px")
                                .style("margin-top", (xy.min.y - pad) + "px");

                        if (!(zoom in this.levels)) {
                            this.levels[zoom] = this.container.append("g").attr("class", "zoom-" + zoom);
                            this.genHexagons(this.levels[zoom]);
                            this.levels[zoom].attr("transform", "translate(" + -(xy.min.x - pad) + "," + -(xy.min.y - pad) + ")");
                        }
                        if (this.curLevel) {
                            this.curLevel.style("display", "none");
                        }
                        this.curLevel = this.levels[zoom];
                        this.curLevel.style("display", "inline");
                    },
                    genHexagons: function (container) {
                        var data = this.rwData.features.map(function (d) {
                            var coords = this.project(d.geometry.coordinates)
                            return [coords[0],coords[1], d.properties];
                        }, this);

                        var bins = this.layout(data);
                        var hexagons = container.selectAll(".hexagon").data(bins);

                        var counts = [];
                        bins.map(function (elem) { counts.push(elem.length) });
                        this.rscale.domain([0, (ss.mean(counts) + (ss.standard_deviation(counts) * 3))]);

                        var path = hexagons.enter().append("path").attr("class", "hexagon");
                        this.config.style.call(this, path);

                        that = this;
                        hexagons
                                .attr("d", function(d) { return that.layout.hexagon(that.rscale(d.length)); })
                                .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                                .on("mouseover", function (d) {
                                    var s=0, k=0;
                                    d.map(function(e){
                                        if (e.length === 3) e[2].group === 1 ? ++k : ++s;
                                    });
                                    that.config.mouse.call(this, [s,k]);
                                    d3.select("#tooltip")
                                            .style("visibility", "visible")
                                            .style("top", function () { return (d3.event.pageY - 130)+"px"})
                                            .style("left", function () { return (d3.event.pageX - 130)+"px";})
                                })
                                .on("mouseout", function (d) { d3.select("#tooltip").style("visibility", "hidden") });
                    },
                    addTo: function (map) {
                        map.addLayer(this);
                        return this;
                    },
                    onAdd: function (map) {
                        this.map = map;
                        var overlayPane = this.map.getPanes().overlayPane;

                        if (!this.container || overlayPane.empty) {
                            this.container = d3.select(overlayPane)
                                    .append('svg')
                                    .attr("id", "hex-svg")
                                    .attr('class', 'leaflet-layer leaflet-zoom-hide');
                        }
                        map.on({ 'moveend': this.update }, this);
                        this.update();
                    }
                });


                L.hexbinLayer = function (data, styleFunction) {
                    return new L.HexbinLayer(data, styleFunction);
                };

                d3.csv('data/coffee1.csv', function (error, coffee) {

                    function reformat (array) {
                        var data = [];
                        array.map(function (d){
                            data.push({
                                properties: {
                                    group: +d.group,
                                    city: d.city,
                                    state: d.state,
                                    store: d.storenumber
                                },
                                type: "Feature",
                                geometry: {
                                    coordinates:[+d.longitude,+d.latitude],
                                    type:"Point"
                                }
                            });
                        });
                        return data;
                    }

                    var geoData = { type: "FeatureCollection", features: reformat(coffee) };
                    //**********************************************************************************
                    //********  CREATE LEAFLET MAP *****************************************************
                    //**********************************************************************************
                    var cscale = d3.scale.linear().domain([0,1]).range(["#00FF00","#FFA500"]);
                    // PLEASE DO NOT USE MY MAP ID :)  YOU CAN GET YOUR OWN FOR FREE AT MAPBOX.COM


                    var leafletMap =L.mapbox.map('hexbinContainer', 'deepakrohan.lngcp9ig')
                            .setView([states[state_code+" latitude"], states[state_code+" longitude"]], 6);

                    //**********************************************************************************
                    //********  ADD HEXBIN LAYER TO MAP AND DEFINE HEXBIN STYLE FUNCTION ***************
                    //**********************************************************************************
                    var hexLayer = L.hexbinLayer(geoData, {
                        style: hexbinStyle,
                        mouse: makePie
                    }).addTo(leafletMap);

                    function hexbinStyle(hexagons) {
                        hexagons
                                .attr("stroke", "black")
                                .attr("fill", function (d) {
                                    var values = d.map(function (elem) {
                                        return elem[2].group;
                                    })
                                    var avg = d3.mean(d, function(d) { return +d[2].group; })
                                    return cscale(avg);
                                });
                    }

                    //**********************************************************************************
                    //********  PIE CHART ROLL-OVER ****************************************************
                    //**********************************************************************************
                    function makePie (data) {

                        d3.select("#tooltip").selectAll(".arc").remove()
                        d3.select("#tooltip").selectAll(".pie").remove()

                        var arc = d3.svg.arc()
                                .outerRadius(45)
                                .innerRadius(10);

                        var pie = d3.layout.pie()
                                .value(function(d) { return d; });

                        var svg = d3.select("#tooltip").select("svg")
                                .append("g")
                                .attr("class", "pie")
                                .attr("transform", "translate(50,50)");

                        var g = svg.selectAll(".arc")
                                .data(pie(data))
                                .enter().append("g")
                                .attr("class", "arc");

                        g.append("path")
                                .attr("d", arc)
                                .style("fill", function(d, i) { return i === 1 ? "#FFA500":"#00FF00"; });

                        g.append("text")
                                .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
                                .style("text-anchor", "middle")
                                .text(function (d) { return d.value === 0 ? "" : d.value; });
                    }
                });
            }
        });
        //]]>
    </script>
    <style type="text/css">
        * {margin:0;padding:0;}

        #map_container {position:relative;margin:10px; display: inline;}
        #map_canvas {width:80%;height:300px;border:1px solid black;}
        #map_reset_button {display:none;position:absolute;top:24px;left:212px;border:1px solid black;}
        #map_reset_button a {width:119px;height:15px;line-height:15px;font-family:arial,sans-serif;color:black;border-style:solid;border-color:rgb(208, 208, 208) rgb(112, 112, 112) rgb(112, 112, 112) rgb(208, 208, 208);border-width:1px;text-decoration:none;display:block;font-size:12px;background-color:white;text-align:center;}
        #map_reset_button a:hover {border-color: rgb(112, 112, 112) rgb(208, 208, 208) rgb(208, 208, 208) rgb(112, 112, 112);}
        #hash_tags{ float: right; display: inline; width: 15%; border: 1px solid black; padding: 20px; margin-right: 3px; margin-left: 10px;}
        #state,#hash_tag{
            margin-top: 10px;
            width: 100%;
            height: 40px;
            font-size: 18px;
            font-weight: bolder;
            padding-left: 10px;
        }

        #chartdiv {
            width	: 39%;
            height	: 360px;
            float: right;
            display:inline;
        }

        #hexbinContainer {
            float: left;
            margin-top: -5px;
            margin-left: 10px;
            background-color: #333;
            width: 60%;
            height: 360px;
        }
        #tooltip {
            opacity: .9;
            background: #333;
            padding: 5px;
            border: 1px solid lightgrey;
            border-radius: 5px;
            position: absolute;
            z-index: 10;
            visibility: hidden;
            pointer-events: none;
        }
    </style>
</head>
<body id="myBody">
<h1 style="margin-bottom: -10px;"><center>Twitter Stream Analysis</center></h1><br/>
<div id="map_container">
    <div id="map_canvas" style="display:inline-block;margin-top: 10px;"></div>


</div>
</div>

<div id="hash_tags" style="display:inline-block;margin-top: 10px;">
    <center><h2>Select State</h2></center>

    <select id="state">
        <option>California</option>
        <option>New York</option>
        <option>North Carolina</option>
        <option>Illinois</option>

    </select><br/><br/>
    <center><h2 style="background-color:green">Hottest Topic</h2> <h2><i><div id="topic" style="color:#000DFF; margin-top: 5px;"></div></i></h2></center>
    <center><br/><h2 style="background-color:orange">Select Hash Tag</h2></center>

    <select id="hash_tag"></select>
</div>

<div id="hexbinContainer" style="display:inline-block;margin-top: 10px;"></div>
<div id="tooltip">
    <svg width="100px" height="100px"></svg>
</div>

<div id="chartdiv"></div>

</body>
</html>
